<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì¸í…Œë¦¬ì–´ ê°€êµ¬ ì¶”ì²œ ì±—ë´‡</title>
<style>
body { font-family: Arial; display: flex; padding: 20px; gap: 40px; }
#chatContainer { width: 450px; height: 600px; border:1px solid #ccc; padding:15px; overflow-y:auto; border-radius:10px;}
.msg { margin:10px 0; max-width:80%; padding:10px 15px; border-radius:15px; line-height:1.4; }
.bot { background:#f0f0f0; align-self:flex-start; }
.user { background:#d1e7ff; align-self:flex-end; margin-left:auto; }
#chatInputArea { margin-top:10px; display:flex; gap:10px; }
#chatInput { flex:1; padding:10px; }
#rightPanel { flex:1; }
img { max-height:200px; margin:10px 0; cursor:pointer; }
</style>
</head>
<body>

<!-- ì±—ë´‡ UI -->
<div>
<h2>ì¸í…Œë¦¬ì–´ ê°€êµ¬ ì¶”ì²œ ì±—ë´‡</h2>
<div id="chatContainer"></div>
<div id="chatInputArea">
<input id="chatInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
<button onclick="sendMessage()">ì „ì†¡</button>
</div>
</div>

<!-- ì´ë¯¸ì§€ / ì¶”ì²œ ì˜ì—­ -->
<div id="rightPanel">
<h3>ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>
<input type="file" id="imageInput">
<button onclick="uploadImage()">ì—…ë¡œë“œ</button>

<h3>ë¶„ì„ ì´ë¯¸ì§€</h3>
<div id="detectedArea"></div>

<h3>ì¶”ì²œ Top3</h3>
<div id="top3Area"></div>
</div>

<script>
const chat = document.getElementById("chatContainer");

// ================= ì±—ë´‡ ë©”ì‹œì§€ =================
function addBot(text){
    const div = document.createElement("div");
    div.className="msg bot";
    div.innerText=text;
    chat.appendChild(div);
    chat.scrollTop=chat.scrollHeight;
}
function addUser(text){
    const div=document.createElement("div");
    div.className="msg user";
    div.innerText=text;
    chat.appendChild(div);
    chat.scrollTop=chat.scrollHeight;
}

// ================= AI ì±—ë´‡ í˜¸ì¶œ =================
async function sendToAI(msg){
    const res = await fetch("/chat", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message:msg})
    });
    const data = await res.json();
    
    // í…ìŠ¤íŠ¸ ë‹µë³€ ì¶œë ¥
    addBot(data.reply);

    // Top3 ì¶”ì²œì´ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ UIì— ìë™ í‘œì‹œ
    if(data.top3){
        const area = document.getElementById("top3Area");
        area.innerHTML = "";                    

        data.top3.forEach(item=>{
            const img = document.createElement("img");
            img.src = item.url;  
            area.appendChild(img);
        });
    }
}


// ================= ì±„íŒ… ì „ì†¡ =================
function sendMessage(){
    const msg=document.getElementById("chatInput").value.trim();
    if(!msg) return;
    addUser(msg);
    document.getElementById("chatInput").value="";
    sendToAI(msg);
}

// ================= ì´ë¯¸ì§€ ì—…ë¡œë“œ =================
async function uploadImage(){
    const file=document.getElementById("imageInput").files[0];
    if(!file) return addBot("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
    addBot("ì´ë¯¸ì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...ğŸ”");

    const form = new FormData();
    form.append("image", file);

    const res = await fetch("/detect", {method:"POST", body:form});
    const data = await res.json();

    // ê°ì§€ ì´ë¯¸ì§€ í‘œì‹œ
    document.getElementById("detectedArea").innerHTML=`<img src="${data.upload_image}">`;

    // Top3 ì´ˆê¸°í™”
    document.getElementById("top3Area").innerHTML="";

    // ê°ì§€ëœ í´ë˜ìŠ¤ ì •ë³´ ì±—ë´‡ì— ì „ë‹¬
    if(data.classes && data.classes.length>0){
        const clsList = data.classes.join(", ");
        sendToAI(`ì´ë¯¸ì§€ ë¶„ì„ ì™„ë£Œ. ê°ì§€ëœ ê°ì²´: ${clsList}. ì–´ë–¤ ê°€êµ¬ë¥¼ ì¶”ì²œë°›ê³  ì‹¶ë‚˜ìš”?`);
    } else {
        addBot("ê°ì²´ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
    }
}

// ================= Top3 ì¶”ì²œ =================
async function loadTop3(cls){
    const res = await fetch(`/top3?class=${cls}`);
    const data = await res.json();
    const area = document.getElementById("top3Area");
    area.innerHTML="";
    data.top3.forEach(item=>{
        const img = document.createElement("img");
        img.src = item.url;
        area.appendChild(img);
    });
    sendToAI(`${cls} ì¶”ì²œ Top3ë¥¼ ë³´ì—¬ì¤¬ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê°ì²´ë¥¼ ì¶”ì²œë°›ê±°ë‚˜ ìƒˆ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
}

// ================= ê°ì²´ í´ë¦­ ì‹œ Top3 í˜¸ì¶œ =================
document.getElementById("detectedArea").addEventListener("click", e=>{
    if(e.target.tagName==="IMG"){
        const cls = e.target.getAttribute("data-class");
        if(cls) loadTop3(cls);
    }
});
</script>

</body>
</html>
